<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢–µ—Å—Ç CSP –∏ CORS</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 5px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>üß™ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É</h1>

    <div class="info">
      <strong>–¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ URL:</strong>
      <ul>
        <li>–õ–æ–∫–∞–ª—å–Ω—ã–π: http://localhost:3001/api/files</li>
        <li>–ü—Ä–æ–¥–∞–∫—à–Ω: http://109.205.212.29:3001/api/files</li>
      </ul>
    </div>

    <button onclick="testLocalServer()">üè† –¢–µ—Å—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞</button>
    <button onclick="testProductionServer()">üåê –¢–µ—Å—Ç –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–∞</button>
    <button onclick="clearResults()">üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>

    <div id="results"></div>

    <script>
      function addResult(message, type = "info") {
        const results = document.getElementById("results");
        const div = document.createElement("div");
        div.className = `result ${type}`;
        div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
        results.appendChild(div);
        results.scrollTop = results.scrollHeight;
      }

      function clearResults() {
        document.getElementById("results").innerHTML = "";
      }

      async function testServer(url, name) {
        addResult(`üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${name}: ${url}`, "info");

        try {
          const startTime = Date.now();
          const response = await fetch(url);
          const endTime = Date.now();

          addResult(
            `üìä –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –∑–∞ ${endTime - startTime}–º—Å, —Å—Ç–∞—Ç—É—Å: ${
              response.status
            }`,
            "info"
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          const filesCount = data.files?.length || 0;

          addResult(
            `‚úÖ ${name} —Ä–∞–±–æ—Ç–∞–µ—Ç! –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${filesCount}`,
            "success"
          );

          if (filesCount > 0) {
            addResult(
              `üìÑ –ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞: ${data.files[0].filename} (${Math.round(
                data.files[0].size / 1024
              )}KB)`,
              "info"
            );
          }
        } catch (error) {
          addResult(`‚ùå –û—à–∏–±–∫–∞ ${name}: ${error.message}`, "error");

          // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫
          if (error.message.includes("Failed to fetch")) {
            addResult(
              `üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã: CSP –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, CORS –æ—à–∏–±–∫–∞, —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω`,
              "error"
            );
          } else if (error.message.includes("NetworkError")) {
            addResult(
              `üîç –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ`,
              "error"
            );
          }
        }
      }

      function testLocalServer() {
        testServer("http://localhost:3001/api/files", "–õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä");
      }

      function testProductionServer() {
        testServer("http://109.205.212.29:3001/api/files", "–ü—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä");
      }

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      window.addEventListener("load", () => {
        addResult("üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!", "info");

        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞—É–∑–µ—Ä–µ
        addResult(`üåê –ë—Ä–∞—É–∑–µ—Ä: ${navigator.userAgent}`, "info");
        addResult(`üì° –û–Ω–ª–∞–π–Ω: ${navigator.onLine ? "–î–∞" : "–ù–µ—Ç"}`, "info");
      });
    </script>
  </body>
</html>
